name: ğŸš€ Release Dotnet Package

on:
  workflow_call:
    inputs:
      project:
        description: The relative path to the .NET project file (e.g., `MyProject.csproj`).
        required: true
        type: string
      global-json-file:
        description: The relative path to the `global.json` file to extract Dotnet version.
        required: true
        type: string
      version-type:
        description: Specifies the version type (e.g., major, minor, patch) for the build.
        required: true
        type: string
    secrets:
      github-token:
        description: The GitHub token for authentication.
        required: true
      nuget-api-key:
        description: NuGet API key used for authenticating and publishing the package.
        required: true

jobs:
  shared:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump_version.outputs.next-version }}
      changelog: ${{ steps.generate_changelog.outputs.changelog }}
      filename: ${{ steps.generate_filename.outputs.filename }}
      title: ${{ steps.generate_title.outputs.title }}

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ†™ Bump Version
        id: bump_version
        uses: grovegs/actions/.github/actions/bump-version@refactor/reusable-workflow
        with:
          version-type: ${{ inputs.version-type }}

      - name: ğŸ“ Generate Changelog
        id: generate_changelog
        run: |
          echo "changelog=${{ steps.bump_version.outputs.latest-version }} - ${{ steps.bump_version.outputs.next-version }}" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Generate Filename
        id: generate_filename
        run: |
          filename=$(echo $(basename "${{ inputs.project }}") | sed -E 's/([a-z])([A-Z])/\1-\2/g' | tr '[:upper:]' '[:lower:]')-${{ steps.bump_version.outputs.next-version }}
          echo "filename=$filename" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate Title
        id: generate_title
        run: |
          title="$(echo $(basename "${{ inputs.project }}") | sed -E 's/([a-z])([A-Z])/\1 \2/g') ${{ steps.bump_version.outputs.next-version }}"
          echo "title=$title" >> $GITHUB_OUTPUT

  pack_nuget:
    needs: shared
    runs-on: ubuntu-latest
    outputs:
      file: ${{ steps.pack_nuget.outputs.file }}

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Dotnet
        uses: grovegs/actions/.github/actions/setup-dotnet@refactor/reusable-workflow
        with:
          global-json-file: ${{ inputs.global-json-file }}
          cached: true

      - name: ğŸ—ï¸ Build Dotnet
        uses: grovegs/actions/.github/actions/build-dotnet@refactor/reusable-workflow
        with:
          project: ${{ inputs.project }}
          configuration: Release
          version: ${{ needs.shared.outputs.version }}

      - name: ğŸ“¦ Pack Nuget
        id: pack_nuget
        uses: grovegs/actions/.github/actions/pack-dotnet@refactor/reusable-workflow
        with:
          project: ${{ inputs.project }}
          configuration: Release
          version: ${{ needs.shared.outputs.version }}
          filename: ${{ needs.shared.outputs.filename }}

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          path: ${{ steps.pack_nuget.outputs.file }}

  release_nuget:
    needs: [shared, pack_nuget]
    runs-on: macos-latest

    steps:
      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: ${{ needs.pack_nuget.outputs.file }}

      - name: ğŸš€ Publish Nuget
        uses: grovegs/actions/.github/actions/publish-nuget@refactor/reusable-workflow
        with:
          file: ${{ needs.pack_nuget.outputs.file }}
          api-key: ${{ secrets.nuget-api-key }}

  release_github:
    needs: [shared, pack_nuget]
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“‚ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: ${{ needs.pack_nuget.outputs.file }}

      - name: ğŸš€ Publish to Github
        uses: grovegs/actions/.github/actions/publish-github@refactor/reusable-workflow
        with:
          title: ${{ needs.shared.outputs.title }}
          version: ${{ needs.shared.outputs.version }}
          changelog: ${{ needs.shared.outputs.changelog }}
          github-token: ${{ secrets.github-token }}
          assets: ${{ needs.pack_nuget.outputs.file }}
