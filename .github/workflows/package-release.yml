name: 🚀 Release Package

on:
    workflow_call:
        inputs:
            name:
                description: The name of package.
                required: true
                type: string
            version-type:
                description: Specifies the version type (e.g., major, minor, patch) for the build.
                required: true
                type: string
            dotnet-projects:
                description: Array of .NET project paths to build and package (e.g., ["src/Core", "src/Godot"])
                required: false
                type: string
                default: "[]"
            godot-addons:
                description: Array of Godot addon paths to package (e.g., ["addons/plugin1", "addons/plugin2"])
                required: false
                type: string
                default: "[]"
            unity-packages:
                description: Array of Unity package paths to package (e.g., ["Packages/com.example.package1", "Packages/com.example.package2"])
                required: false
                type: string
                default: "[]"
            global-json-file:
                description: The relative path to the `global.json` file to extract .NET version.
                required: false
                type: string
                default: ""
            directory-build-props:
                description: The relative path to the `Directory.Build.props` file to set version.
                required: false
                type: string
                default: ""
            publish-github:
                description: If true, publish release to GitHub.
                required: false
                type: boolean
                default: true
            publish-nuget:
                description: If true, publish packages to NuGet.
                required: false
                type: boolean
                default: true
            publish-discord:
                description: If true, send Discord notifications.
                required: false
                type: boolean
                default: true

        secrets:
            github-token:
                description: The GitHub token for authentication.
                required: true
            nuget-api-key:
                description: NuGet API key used for authenticating and publishing the package.
                required: false
            discord-webhook:
                description: Discord webhook URL for sending notifications.
                required: false

jobs:
    shared:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.bump_version.outputs.next-version }}
            changelog-plain: ${{ steps.generate_changelog.outputs.changelog-plain }}
            changelog-markdown: ${{ steps.generate_changelog.outputs.changelog-markdown }}
            filename: ${{ steps.generate_filename.outputs.filename }}

        steps:
            - name: 📂 Checkout Code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: 🆙 Bump Version
              id: bump_version
              uses: grovegs/actions/.github/actions/bump-version@v0.1.3
              with:
                  version-type: ${{ inputs.version-type }}

            - name: 📝 Generate Changelog
              id: generate_changelog
              uses: grovegs/actions/.github/actions/generate-changelog@v0.1.3
              with:
                  next-version: ${{ steps.bump_version.outputs.next-version }}

            - name: 📦 Generate Filename
              id: generate_filename
              run: |
                  filename=$(echo "${{ inputs.name }}" | sed -E 's/([[:space:]]|_)/-/g; s/([a-z])([A-Z])/\1-\2/g' | tr '[:upper:]' '[:lower:]')-${{ steps.bump_version.outputs.next-version }}
                  echo "filename=$filename" >> $GITHUB_OUTPUT

            - name: 🔧 Update Directory.Build.props Version
              if: fromJSON(inputs.dotnet-projects)[0] != null && inputs.directory-build-props != ''
              run: |
                  file="${{ inputs.directory-build-props }}"
                  version="${{ steps.bump_version.outputs.next-version }}"

                  if [ -f "$file" ]; then
                      sed -i.bak "s|<Version>.*</Version>|<Version>$version</Version>|g" "$file"
                      sed -i.bak "s|<AssemblyVersion>.*</AssemblyVersion>|<AssemblyVersion>$version</AssemblyVersion>|g" "$file"
                      sed -i.bak "s|<FileVersion>.*</FileVersion>|<FileVersion>$version</FileVersion>|g" "$file"
                      rm -f "$file.bak"
                      echo "Updated version in $file to $version"
                  else
                      echo "Warning: $file not found"
                  fi

            - name: 📝 Store Path Metadata for Directory.Build.props
              if: fromJSON(inputs.dotnet-projects)[0] != null && inputs.directory-build-props != ''
              run: |
                  mkdir -p .artifact-meta
                  echo "${{ inputs.directory-build-props }}" > .artifact-meta/path.txt

            - name: 📤 Upload Directory.Build.props
              if: fromJSON(inputs.dotnet-projects)[0] != null && inputs.directory-build-props != ''
              uses: actions/upload-artifact@v4
              with:
                  name: modified-dotnet-version
                  path: |
                      ${{ inputs.directory-build-props }}
                      .artifact-meta/path.txt

    pack_dotnet_projects:
        if: fromJSON(inputs.dotnet-projects)[0] != null
        needs: shared
        runs-on: ubuntu-latest
        strategy:
            matrix:
                project: ${{ fromJSON(inputs.dotnet-projects) }}

        steps:
            - name: 📂 Checkout Code
              uses: actions/checkout@v5

            - name: 📥 Download Directory.Build.props
              if: inputs.directory-build-props != ''
              uses: actions/download-artifact@v5
              with:
                  name: modified-dotnet-version
                  path: ~/.modified-version

            - name: 📝 Apply Directory.Build.props
              if: inputs.directory-build-props != ''
              run: |
                  if [ -f ~/.modified-version/.artifact-meta/path.txt ]; then
                      original_path=$(cat ~/.modified-version/.artifact-meta/path.txt)
                      filename=$(basename "$original_path")

                      if [ -f ~/.modified-version/$filename ]; then
                          echo "Restoring $filename to $original_path"
                          mkdir -p "$(dirname "$original_path")"
                          cp ~/.modified-version/$filename "$original_path"
                      fi
                  fi

            - name: ⚙️ Setup Dotnet
              uses: grovegs/actions/.github/actions/setup-dotnet@v0.1.3
              with:
                  global-json-file: ${{ inputs.global-json-file }}
                  cache: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}

            - name: 🏗️ Build .NET Project
              uses: grovegs/actions/.github/actions/build-dotnet@v0.1.3
              with:
                  project: ${{ matrix.project }}
                  configuration: Release
                  version: ${{ needs.shared.outputs.version }}

            - name: 📦 Generate Filename
              id: generate_filename
              run: |
                  base_filename="${{ needs.shared.outputs.filename }}"
                  path="${{ matrix.project }}"
                  item_name=$(basename "$path")

                  sanitized_path=$(echo "$path" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
                  artifact_name="${base_filename}-${sanitized_path}"

                  dot_count=$(echo "$item_name" | tr -cd '.' | wc -c)
                  if [ "$dot_count" -ge 2 ]; then
                      platform=$(echo "$item_name" | sed 's/.*\.//' | tr '[:upper:]' '[:lower:]')
                      package_name="${base_filename}-${platform}"
                  else
                      package_name="${base_filename}"
                  fi

                  echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
                  echo "package_name=$package_name" >> $GITHUB_OUTPUT

            - name: 📦 Pack NuGet
              id: pack_nuget
              uses: grovegs/actions/.github/actions/pack-dotnet@v0.1.3
              with:
                  project: ${{ matrix.project }}
                  configuration: Release
                  version: ${{ needs.shared.outputs.version }}
                  filename: ${{ steps.generate_filename.outputs.package_name }}

            - name: 📤 Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.generate_filename.outputs.artifact_name }}
                  path: ${{ steps.pack_nuget.outputs.file }}

    pack_godot_addons:
        if: fromJSON(inputs.godot-addons)[0] != null
        needs: shared
        runs-on: macos-latest
        strategy:
            matrix:
                addon: ${{ fromJSON(inputs.godot-addons) }}

        steps:
            - name: 📂 Checkout Code
              uses: actions/checkout@v5

            - name: 📦 Generate Filename
              id: generate_filename
              run: |
                  base_filename="${{ needs.shared.outputs.filename }}"
                  path="${{ matrix.addon }}"
                  item_name=$(basename "$path")

                  sanitized_path=$(echo "$path" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
                  artifact_name="${base_filename}-${sanitized_path}"

                  package_name="${base_filename}-godot-addon"

                  echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
                  echo "package_name=$package_name" >> $GITHUB_OUTPUT

            - name: 📦 Pack Godot Addon
              id: pack_addon
              uses: grovegs/actions/.github/actions/pack-godot-addon@v0.1.3
              with:
                  addon: ${{ matrix.addon }}
                  version: ${{ needs.shared.outputs.version }}
                  filename: ${{ steps.generate_filename.outputs.package_name }}

            - name: 📤 Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.generate_filename.outputs.artifact_name }}
                  path: ${{ steps.pack_addon.outputs.file }}

            - name: 📦 Generate Modified Artifact Name
              id: modified_artifact_name
              run: |
                  artifact_name=$(echo "modified-${{ matrix.addon }}" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
                  echo "name=$artifact_name" >> $GITHUB_OUTPUT

            - name: 📝 Store Path Metadata
              run: |
                  mkdir -p .artifact-meta
                  echo "${{ matrix.addon }}" > .artifact-meta/path.txt

            - name: 📤 Upload Modified Files
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.modified_artifact_name.outputs.name }}
                  path: |
                      ${{ matrix.addon }}/plugin.cfg
                      .artifact-meta/path.txt

    pack_unity_packages:
        if: fromJSON(inputs.unity-packages)[0] != null
        needs: shared
        runs-on: ubuntu-latest
        strategy:
            matrix:
                package: ${{ fromJSON(inputs.unity-packages) }}

        steps:
            - name: 📂 Checkout Code
              uses: actions/checkout@v5

            - name: 📦 Generate Filename
              id: generate_filename
              run: |
                  base_filename="${{ needs.shared.outputs.filename }}"
                  path="${{ matrix.package }}"
                  item_name=$(basename "$path")

                  sanitized_path=$(echo "$path" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
                  artifact_name="${base_filename}-${sanitized_path}"

                  package_name="${base_filename}-unity-package"

                  echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
                  echo "package_name=$package_name" >> $GITHUB_OUTPUT

            - name: 📦 Pack Unity Package
              id: pack_package
              uses: grovegs/actions/.github/actions/pack-unity-package@v0.1.3
              with:
                  package: ${{ matrix.package }}
                  version: ${{ needs.shared.outputs.version }}
                  filename: ${{ steps.generate_filename.outputs.package_name }}

            - name: 📤 Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.generate_filename.outputs.artifact_name }}
                  path: ${{ steps.pack_package.outputs.file }}

            - name: 📦 Generate Modified Artifact Name
              id: modified_artifact_name
              run: |
                  artifact_name=$(echo "modified-${{ matrix.package }}" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
                  echo "name=$artifact_name" >> $GITHUB_OUTPUT

            - name: 📝 Store Path Metadata
              run: |
                  mkdir -p .artifact-meta
                  echo "${{ matrix.package }}" > .artifact-meta/path.txt

            - name: 📤 Upload Modified Files
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ steps.modified_artifact_name.outputs.name }}
                  path: |
                      ${{ matrix.package }}/package.json
                      .artifact-meta/path.txt

    release_nuget_packages:
        if: fromJSON(inputs.dotnet-projects)[0] != null && needs.pack_dotnet_projects.result == 'success' && inputs.publish-nuget
        needs: [shared, pack_dotnet_projects]
        runs-on: ubuntu-latest
        strategy:
            matrix:
                project: ${{ fromJSON(inputs.dotnet-projects) }}

        steps:
            - name: 📦 Generate Filename
              id: generate_filename
              run: |
                  base_filename="${{ needs.shared.outputs.filename }}"
                  path="${{ matrix.project }}"
                  item_name=$(basename "$path")

                  sanitized_path=$(echo "$path" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
                  artifact_name="${base_filename}-${sanitized_path}"

                  dot_count=$(echo "$item_name" | tr -cd '.' | wc -c)
                  if [ "$dot_count" -ge 2 ]; then
                      platform=$(echo "$item_name" | sed 's/.*\.//' | tr '[:upper:]' '[:lower:]')
                      package_name="${base_filename}-${platform}"
                  else
                      package_name="${base_filename}"
                  fi

                  echo "artifact_name=$artifact_name" >> $GITHUB_OUTPUT
                  echo "package_name=$package_name" >> $GITHUB_OUTPUT

            - name: 📥 Download Artifact
              uses: actions/download-artifact@v5
              with:
                  name: ${{ steps.generate_filename.outputs.artifact_name }}
                  path: ~/.artifacts

            - name: 🚀 Publish NuGet
              uses: grovegs/actions/.github/actions/publish-nuget@v0.1.3
              with:
                  file: ~/.artifacts/${{ steps.generate_filename.outputs.package_name }}.nupkg
                  api-key: ${{ secrets.nuget-api-key }}

    release_github:
        if: always() && needs.shared.result == 'success' && (needs.pack_dotnet_projects.result == 'success' || needs.pack_godot_addons.result == 'success' || needs.pack_unity_packages.result == 'success')
        needs:
            [
                shared,
                pack_dotnet_projects,
                pack_godot_addons,
                pack_unity_packages,
            ]
        runs-on: ubuntu-latest

        steps:
            - name: 📂 Checkout Code
              uses: actions/checkout@v5

            - name: 📥 Download Modified Files
              uses: actions/download-artifact@v5
              continue-on-error: true
              with:
                  pattern: modified-*
                  path: ~/.modified-files

            - name: 📝 Apply Modified Files
              run: |
                  if [ -d ~/.modified-files ]; then
                      for modified_dir in ~/.modified-files/modified-*; do
                          if [ -d "$modified_dir" ] && [ -f "$modified_dir/.artifact-meta/path.txt" ]; then
                              original_path=$(cat "$modified_dir/.artifact-meta/path.txt")
                              echo "Processing: $original_path"

                              for file in "$modified_dir"/*; do
                                  if [ -f "$file" ] && [ "$(basename "$(dirname "$file")")" != ".artifact-meta" ]; then
                                      filename=$(basename "$file")
                                      if [ "$filename" != "path.txt" ]; then
                                          target="$original_path/$filename"
                                          echo "Restoring $filename to $target"
                                          mkdir -p "$(dirname "$target")"
                                          cp "$file" "$target"
                                      fi
                                  fi
                              done
                          fi
                      done
                  fi

            - name: 💾 Commit and Push Version Changes
              if: inputs.publish-github
              id: commit_changes
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add .

                  if git diff --cached --quiet; then
                      echo "has_changes=false" >> $GITHUB_OUTPUT
                  else
                      git commit -m "chore: release version ${{ needs.shared.outputs.version }} [skip ci]"
                      git push origin HEAD:${{ github.ref_name }}
                      echo "has_changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: 📥 Download All Artifacts
              if: inputs.publish-github
              uses: actions/download-artifact@v5
              with:
                  pattern: ${{ needs.shared.outputs.filename }}*
                  path: ~/.artifacts
                  merge-multiple: true

            - name: 🔍 Find Assets
              if: inputs.publish-github
              id: find_assets
              run: |
                  if [ -d ~/.artifacts ]; then
                    assets=$(find ~/.artifacts -type f \( -name "*.nupkg" -o -name "*.zip" -o -name "*.tgz" \) 2>/dev/null | tr '\n' ' ' || echo "")
                  else
                    assets=""
                  fi
                  echo "assets=$assets" >> $GITHUB_OUTPUT
                  echo "Found assets: $assets"

            - name: 🚀 Publish to GitHub
              if: inputs.publish-github
              uses: grovegs/actions/.github/actions/publish-github@v0.1.3
              with:
                  title: ${{ inputs.name }} ${{ needs.shared.outputs.version }}
                  version: ${{ needs.shared.outputs.version }}
                  changelog: ${{ needs.shared.outputs.changelog-markdown }}
                  github-token: ${{ secrets.github-token }}
                  assets: ${{ steps.find_assets.outputs.assets }}

            - name: 📢 Notify Discord Success
              if: success() && inputs.publish-discord
              uses: grovegs/actions/.github/actions/notify-discord@v0.1.3
              with:
                  webhook_url: ${{ secrets.discord-webhook }}
                  title: "✅ ${{ github.event.repository.name }}"
                  description: |
                      ${{ needs.shared.outputs.changelog-markdown }}

                      [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.shared.outputs.version }})
                  color: "3066993"

            - name: 📢 Notify Discord Failure
              if: failure() && inputs.publish-discord
              uses: grovegs/actions/.github/actions/notify-discord@v0.1.3
              with:
                  webhook_url: ${{ secrets.discord-webhook }}
                  title: "❌ ${{ github.event.repository.name }}"
                  description: |
                      Release publication failed.

                      [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  color: "15158332"
