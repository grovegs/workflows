name: ğŸš€ Release Project

on:
    workflow_call:
        inputs:
            project-name:
                description: The name of project
                required: true
                type: string
            version-type:
                description: Specifies the version type such as major, minor, or patch for the build
                required: true
                type: string
            runs-on:
                description: The type of runner to use (ubuntu-latest, macos-latest, or self-hosted label)
                required: false
                type: string
                default: "macos-latest"
            global-json-file:
                description: The relative path to the global.json file to extract .NET and Godot version
                required: false
                type: string
                default: ""
            godot-project:
                description: Path to the Godot project containing the project.godot file
                required: false
                type: string
                default: ""
            godot-path:
                description: Custom directory for Godot installation (default $HOME/.godot)
                required: false
                type: string
                default: ""
            godot-preset-name:
                description: The Godot export preset name to use for the build
                required: false
                type: string
                default: "Default"
            unity-project:
                description: Path to the Unity project containing the ProjectSettings folder
                required: false
                type: string
                default: ""
            unity-path:
                description: Custom directory for Unity installations (default /Applications/Unity on macOS, $HOME on Linux)
                required: false
                type: string
                default: ""
            unity-android-profile-name:
                description: The Unity build profile name to use for Android build
                required: false
                type: string
                default: "Default"
            unity-ios-profile-name:
                description: The Unity build profile name to use for iOS build
                required: false
                type: string
                default: "Default"
            unity-cache:
                description: Flag to enable or disable Unity Library caching
                required: false
                type: boolean
                default: false
            android-java-version:
                description: The Java version to use for Android builds
                required: false
                type: string
                default: "17"
            android-ndk-version:
                description: The Android NDK version to install
                required: false
                type: string
                default: ""
            android-platform-version:
                description: The Android platform version to install
                required: false
                type: string
                default: ""
            android-build-tools-version:
                description: The Android build tools version to install
                required: false
                type: string
                default: ""
            ios-export-method:
                description: The iOS export method (app-store, ad-hoc, development, enterprise)
                required: false
                type: string
                default: "ad-hoc"
            ios-xcode-version:
                description: The Xcode version to use for iOS builds
                required: false
                type: string
                default: ""
            create-tag:
                description: Flag to create and push a Git tag
                required: false
                type: boolean
                default: true
            build-android:
                description: Flag to enable or disable the Android build
                required: false
                default: true
                type: boolean
            build-ios:
                description: Flag to enable or disable the iOS build
                required: false
                default: true
                type: boolean
            publish-github:
                description: If true, publish release to GitHub
                required: false
                type: boolean
                default: false
            publish-firebase:
                description: If true, publish builds to Firebase
                required: false
                type: boolean
                default: false
            tester-groups:
                description: Comma-separated list of tester groups to receive the build
                required: false
                default: ""
                type: string
            publish-testflight:
                description: If true, publish iOS builds to TestFlight
                required: false
                type: boolean
                default: false
            publish-discord:
                description: If true, send Discord notifications
                required: false
                type: boolean
                default: false
        secrets:
            github-token:
                description: The GitHub token for authentication
                required: true
            unity-email:
                description: The Unity account email address
                required: false
            unity-password:
                description: The Unity account password
                required: false
            unity-license-key:
                description: The Unity license serial key
                required: false
            android-keystore:
                description: Base64-encoded content of the Android keystore for signing the build
                required: false
            android-keystore-user:
                description: Username for accessing the Android keystore
                required: false
            android-keystore-password:
                description: Password for accessing the Android keystore
                required: false
            ios-team-id:
                description: The Apple Developer Team ID associated with your Apple Developer account
                required: false
            ios-certificate:
                description: The Base64-encoded iOS distribution certificate in p12 format used for signing the application
                required: false
            ios-certificate-password:
                description: The password used to import the password-protected iOS distribution certificate for signing the application
                required: false
            ios-provisioning-profile:
                description: The Base64-encoded iOS provisioning profile in mobileprovision format required for building the application
                required: false
            ios-api-key:
                description: Base64-encoded App Store Connect API private key from p8 file for TestFlight uploads
                required: false
            ios-api-key-id:
                description: App Store Connect API Key ID for TestFlight uploads
                required: false
            ios-api-issuer-id:
                description: App Store Connect API Issuer ID for TestFlight uploads
                required: false
            firebase-credentials:
                description: Firebase service account credentials for authentication with Firebase services
                required: false
            firebase-app-id-android:
                description: Firebase Android app ID used to upload builds to Firebase App Distribution
                required: false
            firebase-app-id-ios:
                description: Firebase iOS app ID used to upload builds to Firebase App Distribution
                required: false
            discord-webhook:
                description: Discord webhook URL for sending notifications
                required: false

jobs:
    prepare:
        name: Prepare Release
        runs-on: ${{ inputs.runs-on }}
        outputs:
            version: ${{ steps.bump-version.outputs.next-version }}
            changelog-plain: ${{ steps.generate-changelog.outputs.changelog-plain }}
            changelog-markdown: ${{ steps.generate-changelog.outputs.changelog-markdown }}
            filename: ${{ steps.generate-filename.outputs.filename }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: ğŸ“ Generate Changelog
              id: generate-changelog
              uses: grovegs/actions/.github/actions/generate-changelog@v1.0.34

            - name: ğŸ†™ Bump Version
              id: bump-version
              uses: grovegs/actions/.github/actions/bump-version@v1.0.34
              with:
                  version-type: ${{ inputs.version-type }}
                  create-tag: ${{ inputs.create-tag }}

            - name: ğŸ“¦ Generate Filename
              id: generate-filename
              shell: bash
              run: |
                  #!/usr/bin/env bash
                  set -euo pipefail

                  filename=$(echo "${{ inputs.project-name }}" | sed -E 's/([[:space:]]|_)/-/g; s/([a-z])([A-Z])/\1-\2/g' | tr '[:upper:]' '[:lower:]')
                  filename="${filename}-${{ steps.bump-version.outputs.next-version }}"
                  echo "filename=${filename}" >> "${GITHUB_OUTPUT}"

    build-godot-android:
        name: Build Godot Android
        if: inputs.build-android && inputs.godot-project != ''
        needs: prepare
        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6

            - name: ğŸ”§ Setup .NET
              uses: grovegs/actions/.github/actions/setup-dotnet@v1.0.34
              with:
                  global-json-file: ${{ inputs.global-json-file }}

            - name: ğŸ® Setup Godot
              uses: grovegs/actions/.github/actions/setup-godot@v1.0.34
              with:
                  global-json-file: ${{ inputs.global-json-file }}
                  target-platforms: Android
                  godot-path: ${{ inputs.godot-path }}

            - name: ğŸ¤– Setup Android
              uses: grovegs/actions/.github/actions/setup-android@v1.0.34
              with:
                  java-version: ${{ inputs.android-java-version }}
                  android-packages: ${{ inputs.android-ndk-version != '' && format('ndk;{0}', inputs.android-ndk-version) || '' }} ${{ inputs.android-platform-version != '' && format('platforms;android-{0}', inputs.android-platform-version) || '' }} ${{ inputs.android-build-tools-version != '' && format('build-tools;{0}', inputs.android-build-tools-version) || '' }}

            - name: ğŸ—ï¸ Build Godot
              id: build-godot
              uses: grovegs/actions/.github/actions/build-godot@v1.0.34
              with:
                  project: ${{ inputs.godot-project }}
                  global-json-file: ${{ inputs.global-json-file }}
                  version: ${{ needs.prepare.outputs.version }}
                  platform: Android
                  preset: ${{ inputs.godot-preset-name }}
                  configuration: Release
                  filename: ${{ needs.prepare.outputs.filename }}
                  android-keystore: ${{ secrets.android-keystore }}
                  android-keystore-user: ${{ secrets.android-keystore-user }}
                  android-keystore-password: ${{ secrets.android-keystore-password }}

            - name: ğŸ“¤ Upload Build Artifact
              uses: grovegs/actions/.github/actions/upload-artifact@v1.0.34
              if: steps.build-godot.outputs.file != ''
              with:
                  name: ${{ needs.prepare.outputs.filename }}-android
                  path: ${{ steps.build-godot.outputs.file }}
                  retention-days: 7

    build-godot-ios:
        name: Build Godot iOS
        if: inputs.build-ios && inputs.godot-project != ''
        needs: prepare
        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6

            - name: ğŸ”§ Setup .NET
              uses: grovegs/actions/.github/actions/setup-dotnet@v1.0.34
              with:
                  global-json-file: ${{ inputs.global-json-file }}

            - name: ğŸ® Setup Godot
              uses: grovegs/actions/.github/actions/setup-godot@v1.0.34
              with:
                  global-json-file: ${{ inputs.global-json-file }}
                  target-platforms: iOS
                  godot-path: ${{ inputs.godot-path }}

            - name: ğŸ Setup Xcode
              if: inputs.ios-xcode-version != ''
              uses: grovegs/actions/.github/actions/setup-xcode@v1.0.34
              with:
                  xcode-version: ${{ inputs.ios-xcode-version }}

            - name: ğŸ—ï¸ Build Godot
              id: build-godot
              uses: grovegs/actions/.github/actions/build-godot@v1.0.34
              with:
                  project: ${{ inputs.godot-project }}
                  global-json-file: ${{ inputs.global-json-file }}
                  version: ${{ needs.prepare.outputs.version }}
                  platform: iOS
                  preset: ${{ inputs.godot-preset-name }}
                  configuration: Release
                  filename: ${{ needs.prepare.outputs.filename }}
                  ios-team-id: ${{ secrets.ios-team-id }}
                  ios-certificate: ${{ secrets.ios-certificate }}
                  ios-certificate-password: ${{ secrets.ios-certificate-password }}
                  ios-provisioning-profile: ${{ secrets.ios-provisioning-profile }}

            - name: ğŸ“¤ Upload Build Artifact
              uses: grovegs/actions/.github/actions/upload-artifact@v1.0.34
              if: steps.build-godot.outputs.file != ''
              with:
                  name: ${{ needs.prepare.outputs.filename }}-ios
                  path: ${{ steps.build-godot.outputs.file }}
                  retention-days: 7

    build-unity-android:
        name: Build Unity Android
        if: inputs.build-android && inputs.unity-project != ''
        needs: prepare
        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6

            - name: ğŸ® Setup Unity
              uses: grovegs/actions/.github/actions/setup-unity@v1.0.34
              with:
                  project: ${{ inputs.unity-project }}
                  unity-modules: android
                  unity-path: ${{ inputs.unity-path }}

            - name: ğŸ—ï¸ Build Unity
              id: build-unity
              uses: grovegs/actions/.github/actions/build-unity@v1.0.34
              with:
                  project: ${{ inputs.unity-project }}
                  version: ${{ needs.prepare.outputs.version }}
                  platform: Android
                  configuration: Release
                  filename: ${{ needs.prepare.outputs.filename }}
                  profile-name: ${{ inputs.unity-android-profile-name }}
                  unity-email: ${{ secrets.unity-email }}
                  unity-password: ${{ secrets.unity-password }}
                  unity-license-key: ${{ secrets.unity-license-key }}
                  unity-path: ${{ inputs.unity-path }}
                  android-keystore: ${{ secrets.android-keystore }}
                  android-keystore-user: ${{ secrets.android-keystore-user }}
                  android-keystore-password: ${{ secrets.android-keystore-password }}
                  cache: ${{ inputs.unity-cache }}

            - name: ğŸ“¤ Upload Build Artifact
              uses: grovegs/actions/.github/actions/upload-artifact@v1.0.34
              if: steps.build-unity.outputs.file != ''
              with:
                  name: ${{ needs.prepare.outputs.filename }}-android
                  path: ${{ steps.build-unity.outputs.file }}
                  retention-days: 7

    build-unity-ios:
        name: Build Unity iOS
        if: inputs.build-ios && inputs.unity-project != ''
        needs: prepare
        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6

            - name: ğŸ Setup Xcode
              if: inputs.ios-xcode-version != ''
              uses: grovegs/actions/.github/actions/setup-xcode@v1.0.34
              with:
                  xcode-version: ${{ inputs.ios-xcode-version }}

            - name: ğŸ® Setup Unity
              uses: grovegs/actions/.github/actions/setup-unity@v1.0.34
              with:
                  project: ${{ inputs.unity-project }}
                  unity-modules: ios
                  unity-path: ${{ inputs.unity-path }}

            - name: ğŸ—ï¸ Build Unity
              id: build-unity
              uses: grovegs/actions/.github/actions/build-unity@v1.0.34
              with:
                  project: ${{ inputs.unity-project }}
                  version: ${{ needs.prepare.outputs.version }}
                  platform: iOS
                  configuration: Release
                  filename: ${{ needs.prepare.outputs.filename }}
                  profile-name: ${{ inputs.unity-ios-profile-name }}
                  unity-email: ${{ secrets.unity-email }}
                  unity-password: ${{ secrets.unity-password }}
                  unity-license-key: ${{ secrets.unity-license-key }}
                  unity-path: ${{ inputs.unity-path }}
                  ios-team-id: ${{ secrets.ios-team-id }}
                  ios-certificate: ${{ secrets.ios-certificate }}
                  ios-certificate-password: ${{ secrets.ios-certificate-password }}
                  ios-provisioning-profile: ${{ secrets.ios-provisioning-profile }}
                  ios-export-method: ${{ inputs.ios-export-method }}
                  cache: ${{ inputs.unity-cache }}

            - name: ğŸ“¤ Upload Build Artifact
              uses: grovegs/actions/.github/actions/upload-artifact@v1.0.34
              if: steps.build-unity.outputs.file != ''
              with:
                  name: ${{ needs.prepare.outputs.filename }}-ios
                  path: ${{ steps.build-unity.outputs.file }}
                  retention-days: 7

    release:
        name: Release Platforms
        if: always() && needs.prepare.result == 'success' && (needs.build-godot-android.result == 'success' || needs.build-godot-ios.result == 'success' || needs.build-unity-android.result == 'success' || needs.build-unity-ios.result == 'success')
        needs:
            [
                prepare,
                build-godot-android,
                build-godot-ios,
                build-unity-android,
                build-unity-ios,
            ]
        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6

            - name: ğŸ“¥ Download Android Artifact
              if: needs.build-godot-android.result == 'success' || needs.build-unity-android.result == 'success'
              uses: grovegs/actions/.github/actions/download-artifact@v1.0.34
              with:
                  name: ${{ needs.prepare.outputs.filename }}-android
                  path: builds/android

            - name: ğŸ“¥ Download iOS Artifact
              if: needs.build-godot-ios.result == 'success' || needs.build-unity-ios.result == 'success'
              uses: grovegs/actions/.github/actions/download-artifact@v1.0.34
              with:
                  name: ${{ needs.prepare.outputs.filename }}-ios
                  path: builds/ios

            - name: ğŸ” Find Build Files
              id: find-build-files
              shell: bash
              run: |
                  #!/usr/bin/env bash
                  set -euo pipefail

                  all_files=""
                  android_file=""
                  ios_file=""

                  if [ -d builds/android ]; then
                    android_file=$(find builds/android -type f \( -name "*.apk" -o -name "*.aab" \) 2>/dev/null | head -n 1)
                    [ -n "${android_file}" ] && all_files="${android_file}"
                  fi

                  if [ -d builds/ios ]; then
                    ios_file=$(find builds/ios -type f -name "*.ipa" 2>/dev/null | head -n 1)
                    if [ -n "${ios_file}" ]; then
                      if [ -n "${all_files}" ]; then
                        all_files="${all_files} ${ios_file}"
                      else
                        all_files="${ios_file}"
                      fi
                    fi
                  fi

                  echo "all-files=${all_files}" >> "${GITHUB_OUTPUT}"
                  echo "android-file=${android_file}" >> "${GITHUB_OUTPUT}"
                  echo "ios-file=${ios_file}" >> "${GITHUB_OUTPUT}"

                  echo "Found all files: ${all_files}"
                  echo "Found Android file: ${android_file}"
                  echo "Found iOS file: ${ios_file}"

            - name: ğŸš€ Publish to GitHub
              if: inputs.publish-github && steps.find-build-files.outputs.all-files != ''
              uses: grovegs/actions/.github/actions/publish-github@v1.0.34
              with:
                  title: ${{ inputs.project-name }} v${{ needs.prepare.outputs.version }}
                  version: v${{ needs.prepare.outputs.version }}
                  changelog: ${{ needs.prepare.outputs.changelog-markdown }}
                  github-token: ${{ secrets.github-token }}
                  assets: ${{ steps.find-build-files.outputs.all-files }}

            - name: ğŸ“¤ Setup Firebase
              if: inputs.publish-firebase && (steps.find-build-files.outputs.android-file != '' || steps.find-build-files.outputs.ios-file != '')
              uses: grovegs/actions/.github/actions/setup-firebase@v1.0.34

            - name: ğŸ“¤ Publish Android to Firebase
              if: inputs.publish-firebase && steps.find-build-files.outputs.android-file != ''
              continue-on-error: true
              uses: grovegs/actions/.github/actions/publish-firebase@v1.0.34
              with:
                  file: ${{ steps.find-build-files.outputs.android-file }}
                  app-id: ${{ secrets.firebase-app-id-android }}
                  credentials: ${{ secrets.firebase-credentials }}
                  release-notes: ${{ needs.prepare.outputs.changelog-plain }}
                  tester-groups: ${{ inputs.tester-groups }}

            - name: ğŸ“¤ Publish iOS to Firebase
              if: inputs.publish-firebase && steps.find-build-files.outputs.ios-file != ''
              continue-on-error: true
              uses: grovegs/actions/.github/actions/publish-firebase@v1.0.34
              with:
                  file: ${{ steps.find-build-files.outputs.ios-file }}
                  app-id: ${{ secrets.firebase-app-id-ios }}
                  credentials: ${{ secrets.firebase-credentials }}
                  release-notes: ${{ needs.prepare.outputs.changelog-plain }}
                  tester-groups: ${{ inputs.tester-groups }}

            - name: ğŸ“¤ Publish to TestFlight
              if: inputs.publish-testflight && steps.find-build-files.outputs.ios-file != ''
              continue-on-error: true
              uses: grovegs/actions/.github/actions/publish-testflight@v1.0.34
              with:
                  file: ${{ steps.find-build-files.outputs.ios-file }}
                  api-key: ${{ secrets.ios-api-key }}
                  api-key-id: ${{ secrets.ios-api-key-id }}
                  api-issuer-id: ${{ secrets.ios-api-issuer-id }}

            - name: ğŸ“¢ Notify Discord Success
              if: success() && inputs.publish-discord
              continue-on-error: true
              uses: grovegs/actions/.github/actions/notify-discord@v1.0.34
              with:
                  webhook-url: ${{ secrets.discord-webhook }}
                  title: âœ… ${{ github.event.repository.name }} v${{ needs.prepare.outputs.version }} (${{ github.ref_name }})
                  description: |
                      ${{ needs.prepare.outputs.changelog-markdown }}

                      [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.version }})
                  color: "3066993"

            - name: ğŸ“¢ Notify Discord Failure
              if: failure() && inputs.publish-discord
              continue-on-error: true
              uses: grovegs/actions/.github/actions/notify-discord@v1.0.34
              with:
                  webhook-url: ${{ secrets.discord-webhook }}
                  title: âŒ ${{ github.event.repository.name }} v${{ needs.prepare.outputs.version }} (${{ github.ref_name }})
                  description: |
                      Release publication failed.

                      [View Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  color: "15158332"

    cleanup:
        name: Cleanup on Failure
        if: always() && (failure() || cancelled()) && needs.prepare.result == 'success' && inputs.create-tag
        needs:
            [
                prepare,
                build-godot-android,
                build-godot-ios,
                build-unity-android,
                build-unity-ios,
                release,
            ]
        runs-on: ${{ inputs.runs-on }}

        steps:
            - name: ğŸ“‚ Checkout Code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: ğŸ—‘ï¸ Delete Tag
              run: |
                  git push origin :refs/tags/v${{ needs.prepare.outputs.version }}
